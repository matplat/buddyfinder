name: Pull Request Checks

on:
  pull_request:
    branches:
      - master

permissions:
  contents: read
  pull-requests: write

env:
  CI: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Prepare workspace
        uses: ./.github/actions/setup-workspace

      - name: Detect changed files
        id: changed
        uses: tj-actions/changed-files@v47
        with:
          files: |
            **/*.ts
            **/*.tsx
            **/*.js
            **/*.jsx
            **/*.astro
            **/*.mjs
            **/*.mts
            **/*.cjs
            **/*.cts

      - name: Run ESLint on changed files
        run: |
          if [ -z "${{ steps.changed.outputs.all_changed_files }}" ]; then
            echo "No lintable files changed."
            exit 0
          fi

          echo "${{ steps.changed.outputs.all_changed_files }}" | tr '\n' '\0' | xargs -0 npx eslint --max-warnings=0

  test_unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Prepare workspace
        uses: ./.github/actions/setup-workspace

      - name: Run unit tests
        run: npm run test:unit

  test_e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: lint
    environment: integration
    env:
      PLAYWRIGHT_BASE_URL: ${{ vars.PLAYWRIGHT_BASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Prepare workspace
        uses: ./.github/actions/setup-workspace

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run end-to-end tests
        run: npm run test:e2e

  comment:
    name: Report Results
    runs-on: ubuntu-latest
    needs:
      - lint
      - test_unit
      - test_e2e
    if: always()
    steps:
      - name: Comment on pull request
        uses: actions/github-script@v8
        with:
          script: |
            const results = {
              lint: '${{ needs.lint.result }}',
              unit: '${{ needs.test_unit.result }}',
              e2e: '${{ needs.test_e2e.result }}',
            };

            const statusEmoji = (status) => {
              if (status === 'success') return '✅';
              if (status === 'failure') return '❌';
              if (status === 'cancelled') return '⚠️';
              return '⏭️';
            };

            const body = [
              '### Pull Request check summary',
              '',
              `- ${statusEmoji(results.lint)} Lint: **${results.lint}**`,
              `- ${statusEmoji(results.unit)} Unit tests: **${results.unit}**`,
              `- ${statusEmoji(results.e2e)} E2E tests: **${results.e2e}**`,
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });